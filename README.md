# `vulnerability_detection` ðŸ§¨

---

- [Description](#description)
  - [Limitations](#limitations)
- [How It Works](#how-it-works)
- [Setup](#setup)
- [Usage](#usage)
  - [As a CLI Tool](#as-a-cli-tool)
    - [Fuzz Files](#fuzz-files)
    - [Fuzz Standard Input](#fuzz-standard-input)
    - [Fuzz Arguments](#fuzz-arguments)
    - [Get Help](#get-help)
  - [As a Python Module](#as-a-python-module)

---

## Description

`vulnerability_detection` is a module in OpenCRS for finding vulnerabilities in executables. At the moment, the only implemented technique is fuzzing.

### Limitations

- ELF format
- x86 architecture

## How It Works

All implemented fuzzers automate AFL++, starting from the official Docker container.
The standard input and the files one use the off-the-shelf functionality.

The arguments fuzzer adapts the standard input fuzzer using a custom C adapter.
The latter received the generated input and instantiate a format string that is passed as argument.
The result is then injected in the `argv` of the fuzzed program.  

## Setup


1. Make sure you have set up the repositories and Python environment according to the [top-level instructions](https://github.com/open-crs#requirements).
   That is:

   - Docker is installed and is properly running.
     Check using:

     ```console
     docker version
     docker ps -a
     docker run --rm hello-world
     ```

     These commands should run without errors.

   - The current module repository and all other module repositories (particularly the [`dataset` repository](https://github.com/open-crs/dataset) and the [`commons` repository](https://github.com/open-crs/commons)) are cloned in the same directory.

   - You are running all commands inside a Python virtual environment.
     There should be `(.venv)` prefix to your prompt.

   - You have installed Poetry in the virtual environment.
     If you run:

     ```console
     which poetry
     ```

     you should get a path ending with `.venv/bin/poetry`.

1. Disable the Python Keyring:

   ```console
   export PYTHON_KEYRING_BACKEND=keyring.backends.null.Keyring
   ```

   This is a problem that may occur in certain situations, preventing Poetry from getting packages.

1. Install the required packages with Poetry (based on `pyprojects.toml`):

   ```console
   poetry install --only main
   ```

1. Build the Docker image: 

   ```console
   docker build --build-arg USER_ID=<uid> --build-arg GROUP_ID=<guid> --tag aflplusplus -f docker/Dockerfile.aflplusplus .
   ```
   where `<uid>` and `<guid>` are the individual and group IDs of the current user.

1. Ensure the Docker API is accessible by:

   - Running the module as `root`; or
   - Changing the Docker socket permissions (unsecure approach) via `sudo chmod 777 /var/run/docker.sock`.

1. Build the arguments' adapter via:

  ```consloe
    cd argv_adapter && make
  ```

## Usage

You can use the `vulnerability_detection` module either standalone, as a CLI tool, or integrated into Python applications, as a Python module.

### As a CLI Tool

As a CLI tool, you can either use the `cli.py` module:

```console
vulnerability_detection/cli.py
```

or the Poetry interface:

```console
poetry run vulnerability_detection
```

#### Fuzz Files

```bash
âžœ poetry run vulnerability_detection fuzz --fuzzer FILES_AFLPLUSPLUS --stream FILES --elf file_bof.elf --samples samples --arguments "--file"
New proof of vulnerability was generated with the following payloads:

- For FILES:

00000000: 79 80 80                                          y..
```

#### Fuzz Standard Input

```bash
âžœ poetry run vulnerability_detection fuzz --fuzzer STDIN_AFLPLUSPLUS --stream STDIN --elf stdin_bof.elf --samples samples                     
New proof of vulnerability was generated with the following payloads:

- For STDIN:

00000000: 70 00 00 00 00 00 00 00  00 00 00 00 E5 00 00 CF  p...............
00000010: 6B 6D                                             km
```

#### Fuzz Arguments

```bash
âžœ poetry run vulnerability_detection fuzz --fuzzer ARGS_AFLPLUSPLUS --stream ARGUMENTS --elf argv_null_deref.elf --samples samples --arguments "--string %s"
New proof of vulnerability was generated with the following payloads:

- For ARGUMENTS:

00000000: 73 1D 0A AC 61 20 0A 00                           s...a ..
```

#### Get Help

```bash
âžœ poetry run vulnerability_detection            
Usage: vulnerability_detection [OPTIONS] COMMAND [ARGS]...

  Discovers vulnerabilities in executables.

Options:
  --help  Show this message and exit.

Commands:
  fuzz  Find vulnerabilities by using a fuzzer.
```

### As a Python Module

```python
from vulnerability_detection.fuzzing import (
    PoVConsumer,
    StdinAFLPlusPlus,
    InputStreams,
    ProofOfVulnerability
)

class CustomPoVConsumer(PoVConsumer):
    def notify_new_pov(self, pov: ProofOfVulnerability) -> None:
        # Process the ProofOfVulnerability object

fuzzer = StdinAFLPlusPlus()
fuzzer.set_input_stream(InputStreams.STDIN)
fuzzer.set_target(target_elf, samples_folder)

consumer = CustomPoVConsumer()
fuzzer.attach_consumer(consumer)

fuzzer.start_fuzzing()
```
